<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Journal Club - Dr. Holtkamp Edition</title>
    <!-- Tailwind CSS for rapid, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MathJax for rendering medical formulas -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom Theme Overrides */
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --accent: #e94560;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .glass-panel {
            background: rgba(22, 33, 62, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Markdown Styles within the content area */
        .prose-invert h1, .prose-invert h2, .prose-invert h3 {
            color: #F39C12;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 700;
        }
        .prose-invert h2 { border-bottom: 1px solid #333; padding-bottom: 5px; }
        .prose-invert strong { color: var(--accent); }
        .prose-invert ul { list-style-type: disc; padding-left: 20px; margin: 10px 0; }
        .prose-invert li { margin-bottom: 5px; }
        .prose-invert p { margin-bottom: 1em; line-height: 1.7; }
        .prose-invert a { color: #38bdf8; text-decoration: underline; } /* Link styling */
        
        /* Loading Animation */
        .pulse-ring {
            display: inline-block;
            width: 64px;
            height: 64px;
        }
        .pulse-ring:after {
            content: " ";
            display: block;
            width: 46px;
            height: 46px;
            margin: 1px;
            border-radius: 50%;
            border: 5px solid var(--accent);
            border-color: var(--accent) transparent var(--accent) transparent;
            animation: ring 1.2s linear infinite;
        }
        @keyframes ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- Header -->
    <header class="w-full max-w-4xl text-center mb-10">
        <h1 class="text-4xl md:text-5xl font-extrabold text-orange-500 tracking-tight mb-3">Medical Journal Club</h1>
        <!-- Prominent Subtitle -->
        <p class="text-blue-50 mt-2 text-2xl font-semibold leading-relaxed">Evidence summaries, audio breakdowns, and landmark trials</p>
        <!-- Subdued Sub-subtitle -->
        <p class="text-gray-500 text-sm mt-3 italic">Learning Starts Now - Brought to you by Dr. Matthew Holtkamp</p>
    </header>

    <main class="w-full max-w-4xl">
        
        <!-- Disclaimer -->
        <div class="bg-blue-900/30 border border-blue-800 rounded-lg p-4 mb-8 text-center text-xs text-blue-200">
            <strong>Educational Use Only.</strong> Not medical advice. Verify all citations and guidelines clinically.
        </div>

        <!-- STEP 1: Initial Topic -->
        <div id="step1" class="glass-panel rounded-xl p-6 shadow-2xl mb-6">
            <form id="queryForm" class="space-y-4">
                <div>
                    <label class="block text-lg font-semibold mb-2">Topic or Clinical Question</label>
                    <input type="text" id="initialQuestion" 
                           class="w-full bg-slate-800 border border-slate-600 rounded-lg p-4 text-white focus:ring-2 focus:ring-orange-500 outline-none transition"
                           placeholder="e.g., Dual antiplatelet therapy after minor stroke" required>
                </div>
                <button type="submit" id="btnRefine"
                        class="w-full bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex justify-center items-center gap-2">
                    <span>Initialize Refinement</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </form>
        </div>

        <!-- STEP 2: Refinement (Dynamic) -->
        <div id="step2" class="glass-panel rounded-xl p-6 shadow-2xl mb-6 hidden">
            <!-- UPDATED HEADER -->
            <h3 class="text-xl font-bold text-orange-400 mb-4 border-b border-gray-700 pb-2">Refining Questions</h3>
            <form id="refinementForm" class="space-y-4">
                <div id="dynamicInputs" class="space-y-4"></div>
                
                <div class="flex gap-4 pt-2">
                    <button type="button" id="btnBackToStep1" class="w-1/3 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg">
                        Back
                    </button>
                    <button type="submit" id="btnGenerate"
                            class="w-2/3 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-[1.01]">
                        Generate Analysis
                    </button>
                </div>
            </form>
        </div>

        <!-- Loader -->
        <div id="loader" class="hidden text-center py-12">
            <div class="pulse-ring"></div>
            <p id="loaderText" class="mt-4 text-orange-400 font-mono text-sm animate-pulse">Analyzing Clinical Trials...</p>
        </div>

        <!-- STEP 3: Results -->
        <div id="results" class="hidden">
            
            <!-- UPDATED TOOLBAR (GRID LAYOUT) -->
            <!-- 8 columns total. Listen takes 4 (50%). The other 4 take 1 each. -->
            <div class="grid grid-cols-2 md:grid-cols-8 gap-2 mb-6 bg-slate-800/50 p-3 rounded-lg border border-slate-700 items-stretch">
                
                <!-- Listen Button: Biggest, First, Half Width -->
                <button id="btnAudio" class="col-span-2 md:col-span-4 bg-teal-700 hover:bg-teal-600 text-white px-4 py-3 rounded-lg font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition-all h-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                    Listen
                </button>

                <!-- New Topic -->
                <button id="btnNewTopic" class="md:col-span-1 bg-red-900/40 hover:bg-red-900/60 text-red-200 px-2 py-3 rounded-lg font-semibold text-xs md:text-sm border border-red-900/50 flex items-center justify-center h-full">
                    New Topic
                </button>

                <!-- Back -->
                <button id="btnBackToRefine" class="md:col-span-1 bg-slate-700 hover:bg-slate-600 text-gray-200 px-2 py-3 rounded-lg font-medium text-xs md:text-sm flex items-center justify-center h-full">
                    Back
                </button>
                
                <!-- Copy Text -->
                <button id="btnCopy" class="md:col-span-1 bg-slate-700 hover:bg-slate-600 text-gray-200 px-2 py-3 rounded-lg font-medium text-xs md:text-sm flex items-center justify-center h-full">
                    Copy Text
                </button>

                <!-- Copy Plan -->
                <button id="btnPlan" class="md:col-span-1 bg-slate-700 hover:bg-slate-600 text-gray-200 px-2 py-3 rounded-lg font-medium text-xs md:text-sm flex items-center justify-center h-full">
                    Copy Plan
                </button>
            </div>
            
            <!-- Audio Player Container -->
            <div id="audioContainer" class="hidden mb-6 p-4 bg-teal-900/30 border border-teal-800 rounded-lg transition-all duration-300">
                <p class="text-teal-200 text-sm mb-2 font-semibold">üéôÔ∏è Dr. Holtkamp's Analysis</p>
                
                <!-- Progress Bar -->
                <div id="audioProgressContainer" class="w-full bg-gray-700 rounded-full h-2.5 mb-3 hidden">
                    <div id="audioProgressBar" class="bg-teal-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    <p id="audioProgressText" class="text-xs text-teal-400 text-center mt-1">Generating Script...</p>
                </div>

                <audio id="audioPlayer" controls class="w-full hidden"></audio>
            </div>

            <!-- Follow Up (MOVED TO TOP) -->
            <div class="mb-8 p-6 bg-slate-800/30 rounded-lg border border-slate-700">
                <h3 class="text-lg font-bold text-white mb-2">Interactive Discussion</h3>
                <form id="followUpForm" class="flex gap-2">
                    <input type="text" id="followUpInput" class="flex-1 bg-slate-800 border border-slate-600 rounded-lg p-3 text-white focus:border-orange-500 outline-none" placeholder="Ask Dr. Holtkamp a follow-up...">
                    <button type="submit" class="bg-orange-600 hover:bg-orange-500 text-white px-6 rounded-lg font-bold">Ask</button>
                </form>
                <div id="followUpResult" class="mt-4 p-4 bg-slate-800/50 rounded-lg border-l-4 border-orange-500 hidden prose prose-invert max-w-none"></div>
            </div>

            <!-- Content Tabs -->
            <div class="mb-4 border-b border-gray-700 flex gap-6 overflow-x-auto">
                <button class="tab-btn active text-orange-500 border-b-2 border-orange-500 pb-2 px-1 font-bold" data-target="summary">Journal Club</button>
                <button class="tab-btn text-gray-400 hover:text-white pb-2 px-1 font-medium" data-target="plan">Treatment & Plan</button>
                <button class="tab-btn text-gray-400 hover:text-white pb-2 px-1 font-medium" data-target="refs">References</button>
            </div>

            <!-- Content Areas -->
            <div id="summaryContent" class="tab-content prose prose-invert max-w-none text-gray-300"></div>
            <div id="planContent" class="tab-content hidden prose prose-invert max-w-none text-gray-300"></div>
            <div id="refsContent" class="tab-content hidden font-mono text-sm bg-black/30 p-4 rounded text-gray-400 whitespace-pre-wrap"></div>

        </div>

    </main>

    <!-- PCM to WAV Library (Inlined for single file portability) -->
    <script>
    !function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.pcmToWav=t():e.pcmToWav=t()}(window,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){var n,o,a,i,f,c,u,d=new DataView(new ArrayBuffer(44+e.length*t*2));return d.setUint32(0,1380533830,!1),d.setUint32(4,36+e.length*t*2,!0),d.setUint32(8,1463899717,!1),d.setUint32(12,1718449184,!1),d.setUint32(16,16,!0),d.setUint16(20,1,!0),n=t,d.setUint16(22,n,!0),o=r,d.setUint32(24,o,!0),a=r*t*2,d.setUint32(28,a,!0),i=2*t,d.setUint16(32,i,!0),f=16,d.setUint16(34,f,!0),d.setUint32(36,1684108385,!1),c=e.length*t*2,d.setUint32(40,c,!0),u=new Uint8Array(d.buffer,44),e.forEach(function(e,t){var r=44+2*t;d.setInt16(r,e,!0)}),new Blob([d.buffer],{type:"audio/wav"})},e.exports=t.default}])});
    </script>

    <!-- Main Logic -->
    <script>
        // API Configuration
        const apiKey = "AIzaSyD2CAh8chhZkxqQnwuRa2WOMBF3ESYH6yk";
        const GENERATE_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const TTS_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        // DOM Elements
        const el = id => document.getElementById(id);
        const queryForm = el('queryForm');
        const refineForm = el('refinementForm');
        const loader = el('loader');
        const results = el('results');
        const dynamicInputs = el('dynamicInputs');
        const followUpForm = el('followUpForm');
        const progressBar = el('audioProgressBar');
        const progressContainer = el('audioProgressContainer');
        const progressText = el('audioProgressText');
        
        let storedSummary = "";
        let storedContext = "";

        // Improved Retry Logic with Error Parsing
        async function fetchWithRetry(url, payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Handle Service Unavailable / Rate Limits by throwing to catch block
                    if (res.status === 429 || res.status === 503) {
                         throw new Error(`Transient Error: ${res.status}`);
                    }

                    if (!res.ok) {
                        let errorMsg = res.statusText || `Error ${res.status}`;
                        // Try to parse detailed JSON error from API safely
                        try {
                            const text = await res.text();
                            // Attempt to parse JSON
                            try {
                                const errorBody = JSON.parse(text);
                                if (errorBody.error && errorBody.error.message) {
                                    errorMsg = `${res.status} - ${errorBody.error.message}`;
                                } else {
                                    errorMsg = `${res.status} - ${JSON.stringify(errorBody)}`;
                                }
                            } catch (jsonErr) {
                                // If not JSON, use truncated text if short, or just status
                                if (text.length < 500) {
                                    errorMsg = `${res.status} - ${text}`;
                                }
                            }
                        } catch (readError) {
                            // Failed to read response body, keep default statusText
                        }
                        throw new Error(errorMsg);
                    }
                    return await res.json();

                } catch (e) {
                    // Stop retrying if max retries reached
                    if (i === maxRetries - 1) throw e;
                    
                    // Exponential backoff: 1s, 2s, 4s, 8s, 16s
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i)));
                }
            }
        }
        
        // --- Robust Cleaner for LaTeX Artifacts ---
        function stripLatex(text) {
            if (!text) return "";
            return text
                // 1. Remove wrapping $ delimiters for inline math
                .replace(/\$([^$]+)\$/g, '$1')
                // 2. Remove \text{content} wrappers
                .replace(/\\text\s*\{([^}]+)\}/g, '$1')
                // 3. Replace common math symbols
                .replace(/\\geq/g, '‚â•')
                .replace(/\\leq/g, '‚â§')
                .replace(/\\approx/g, '‚âà')
                .replace(/\\pm/g, '¬±')
                .replace(/\\rightarrow/g, '‚Üí')
                .replace(/\\times/g, 'x')
                .replace(/\\cdot/g, '¬∑')
                .replace(/\\%/g, '%')
                // 4. Remove generic backslashes before words
                .replace(/\\([a-zA-Z]+)/g, ' $1 ')
                .trim();
        }

        // --- Navigation Logic ---
        
        // Back to Step 1 (From Refinement)
        el('btnBackToStep1').addEventListener('click', () => {
            el('step2').classList.add('hidden');
            el('step1').classList.remove('hidden');
        });

        // Back to Step 2 (From Results)
        el('btnBackToRefine').addEventListener('click', () => {
            el('results').classList.add('hidden');
            el('step2').classList.remove('hidden');
        });

        // New Topic (Reset)
        el('btnNewTopic').addEventListener('click', () => {
             if(confirm("Start a new topic? This will clear current results.")) {
                 location.reload();
             }
        });


        // STEP 1: Handle Initial Query (Get Refinement Questions)
        queryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const topic = el('initialQuestion').value;
            
            showLoader("Consulting Research Database...");
            el('step1').classList.add('hidden');

            const prompt = `
                Topic: "${topic}"
                Role: Medical Research Librarian.
                Task: Generate 5 specific *clarifying* questions to help the user narrow their search scope (PICO elements).
                
                CRITICAL INSTRUCTION: Do NOT ask knowledge questions (e.g., "What is the pathophysiology?"). 
                Instead, ask questions that force the user to choose a direction (e.g., "Are you interested in pediatric or adult populations?", "Do you want to focus on diagnosis or treatment?", "Which specific drug class is the intervention?").
                
                Output: A simple list of questions, one per line. No bullets, no numbering, just the text.
            `;

            try {
                const data = await fetchWithRetry(GENERATE_URL, {
                    contents: [{ parts: [{ text: prompt }] }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                });
                
                const text = data.candidates[0].content.parts[0].text;
                const questions = text.split('\n').filter(line => line.trim().length > 5).slice(0, 5);
                
                dynamicInputs.innerHTML = '';
                questions.forEach((q, idx) => {
                    dynamicInputs.innerHTML += `
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">${q.replace(/^[Q\-*0-9: ]+/, '')}</label>
                            <input type="text" name="q${idx}" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-white focus:border-orange-500" placeholder="Enter details...">
                        </div>
                    `;
                });

                hideLoader();
                el('step2').classList.remove('hidden');
            } catch (err) {
                alert("Error generating questions. Please try again. " + err.message);
                el('step1').classList.remove('hidden');
                hideLoader();
            }
        });

        // STEP 2: Generate Journal Club Content
        refineForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const topic = el('initialQuestion').value;
            const details = Array.from(dynamicInputs.querySelectorAll('input')).map(i => `${i.previousElementSibling.innerText}: ${i.value}`).join('\n');

            showLoader("Synthesizing Journal Club: Finding 2 Landmark & 2 Recent Trials...");
            el('step2').classList.add('hidden');

            const mainPrompt = `
                Role: Dr. Matthew Holtkamp (Expert Medical Educator).
                Task: Create a Journal Club analysis for: "${topic}".
                Context: ${details}
                
                MANDATORY STRUCTURE:
                1. Identify EXACTLY 4 Key Trials:
                   - Trial 1 & 2: The Two Historical Landmark Trials (The foundation of current practice).
                   - Trial 3 & 4: The Two Most Important Recent/Emerging Trials (Last 5 years preferrable).
                
                2. Use Google Search to find real citations and DATES.
                
                OUTPUT FORMAT (Use Markdown). You MUST use the separators |||SECTION_PLAN||| and |||SECTION_REFS||| exactly as written below to separate sections.
                
                # Journal Club Summary
                
                ## Introduction
                Brief clinical context.
                
                ## Landmark Trial 1: [Trial Name/Acronym]
                * **Year of Publication:** [YYYY]
                * **Design/PICO:**
                * **Results:**
                * **Limitations:**
                * **Link:** [Click to Search](https://www.google.com/search?q=[Trial Name]+[Year])
                
                ## Landmark Trial 2: [Trial Name/Acronym]
                * **Year of Publication:** [YYYY]
                * **Design/PICO:**
                * **Results:**
                * **Limitations:**
                * **Link:** [Click to Search](https://www.google.com/search?q=[Trial Name]+[Year])
                
                ## Recent Major Trial 1: [Trial Name]
                * **Year of Publication:** [YYYY]
                * **Why it matters:**
                * **Key Findings:**
                * **Link:** [Click to Search](https://www.google.com/search?q=[Trial Name]+[Year])
                
                ## Recent Major Trial 2: [Trial Name]
                * **Year of Publication:** [YYYY]
                * **Why it matters:**
                * **Key Findings:**
                * **Link:** [Click to Search](https://www.google.com/search?q=[Trial Name]+[Year])
                
                ## Dr. Holtkamp's Clinical Pearls
                * [Pearl 1]
                * [Pearl 2]
                * [Pearl 3]

                |||SECTION_PLAN|||
                
                # Treatment & Plan
                Based on the evidence above, provide a stepwise clinical plan.
                1. **Initial Workup:**
                2. **First-Line Therapy:**
                3. **Escalation/Refractory Management:**
                
                |||SECTION_REFS|||
                
                [Full APA Citations List]
                
                CLEANLINESS INSTRUCTION: DO NOT use LaTeX syntax (like \\geq, \\text{}, or $...$). Use simple UTF-8 symbols (e.g., ‚â•, mg/kg) or plain text. Use separate paragraphs for clarity.
            `;

            try {
                const data = await fetchWithRetry(GENERATE_URL, {
                    contents: [{ parts: [{ text: mainPrompt }] }],
                    tools: [{ google_search: {} }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                });

                const rawText = data.candidates[0].content.parts[0].text;
                storedContext = rawText; // Save for follow up

                // ROBUST SPLIT LOGIC
                // We split by the distinct tokens.
                const split1 = rawText.split('|||SECTION_PLAN|||');
                storedSummary = split1[0];
                let remaining = split1[1] || "";
                
                const split2 = remaining.split('|||SECTION_REFS|||');
                const planText = split2[0] || "No plan generated. Try refining.";
                const refsText = split2[1] || "No references generated.";

                // APPLY CLEANER (without aggressive newline stripping)
                const cleanSummary = stripLatex(storedSummary);
                const cleanPlan = stripLatex(planText);
                const cleanRefs = stripLatex(refsText);

                el('summaryContent').innerHTML = marked.parse(cleanSummary);
                el('planContent').innerHTML = marked.parse(cleanPlan);
                el('refsContent').innerText = cleanRefs.trim();

                // Typeset Math (only if any valid MathJax remains, though we stripped most)
                MathJax.typesetPromise();

                hideLoader();
                el('results').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("Error synthesizing data. Check API key/Quota. " + err.message);
                el('step2').classList.remove('hidden');
                hideLoader();
            }
        });

        // TABS Logic
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('text-orange-500', 'border-b-2', 'border-orange-500', 'active');
                    b.classList.add('text-gray-400');
                });
                btn.classList.add('text-orange-500', 'border-b-2', 'border-orange-500', 'active');
                btn.classList.remove('text-gray-400');

                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                const target = btn.dataset.target;
                if(target === 'summary') el('summaryContent').classList.remove('hidden');
                if(target === 'plan') el('planContent').classList.remove('hidden');
                if(target === 'refs') el('refsContent').classList.remove('hidden');
            });
        });

        // AUDIO GENERATION (The Holtkamp Persona)
        el('btnAudio').addEventListener('click', async () => {
            const btn = el('btnAudio');
            btn.disabled = true;
            
            // Declare intervals outside try block so they can be cleared in catch
            let scriptInterval, audioInterval;

            // Show Container & Progress
            el('audioContainer').classList.remove('hidden');
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '2%';
            progressText.innerText = "Step 1: Scripting Lecture (Dr. Holtkamp Style)...";

            // Simulated Progress: Step 1 (Scripting) - Fast
            let progress = 2;
            scriptInterval = setInterval(() => {
                if (progress < 20) {
                    progress += 2;
                    progressBar.style.width = `${progress}%`;
                }
            }, 300);

            try {
                // Step 1: Generate the Persona Script (Requested shorter length)
                const scriptPrompt = `
                    You are Dr. Matthew Holtkamp. Convert the following medical summary into a robust audio transcript.
                    
                    Tone: Fun, Professional, Authoritative, but Conversational. 
                    Style: Use rhetorical questions. Say things like "Here is the kicker," "Welcome back to Journal Club," or "Let's cut through the noise."
                    
                    Structure:
                    1. Intro (High energy).
                    2. Discuss the 2 Landmark trials (The history).
                    3. Discuss the 2 Recent trials (The update).
                    4. Give the "Bottom Line" advice.
                    
                    Length: detailed and comprehensive. Aim for roughly 4000-6000 words (approx 7 minutes spoken).
                    
                    TEXT TO ADAPT:
                    ${storedSummary.substring(0, 6000)}
                `;

                const scriptRes = await fetchWithRetry(GENERATE_URL, {
                    contents: [{ parts: [{ text: scriptPrompt }] }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                });
                let script = scriptRes.candidates[0].content.parts[0].text;
                
                // Stop script interval
                clearInterval(scriptInterval);
                progress = 25;
                progressBar.style.width = '25%';

                // --- TRUNCATE FOR SAFETY ---
                // Limit to 10000 chars for safe TTS generation (approx 7 mins)
                if (script.length > 10000) {
                    script = script.substring(0, 10000);
                    const lastPeriod = script.lastIndexOf('.');
                    if (lastPeriod > 0) script = script.substring(0, lastPeriod + 1);
                }

                // Step 2: TTS - Slow Progress simulation
                progressText.innerText = "Step 2: Synthesizing Audio (Est. wait: ~5-7 mins)...";
                
                // Create a slow crawl for the heavy lifting
                audioInterval = setInterval(() => {
                    if (progress < 90) {
                        // Slower increment
                        progress += 0.5; 
                        progressBar.style.width = `${progress}%`;
                    }
                }, 500); // Update every half second
                
                // NOTE: Safety Settings REMOVED for TTS call to prevent 400 Bad Request
                const ttsRes = await fetchWithRetry(TTS_URL, {
                    contents: [{ parts: [{ text: script }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: { prebuiltVoiceConfig: { voiceName: "Sadaltager" } } // Deep, professional voice
                        }
                    }
                });
                
                if (!ttsRes.candidates || !ttsRes.candidates[0]) {
                     throw new Error("TTS API returned no candidates. Text might be too long.");
                }

                const audioData = ttsRes.candidates[0].content.parts[0].inlineData.data;
                const binary = atob(audioData);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                
                // Convert PCM to WAV
                const pcm16 = new Int16Array(bytes.buffer);
                const wavBlob = pcmToWav(pcm16, 1, 24000);
                const audioUrl = URL.createObjectURL(wavBlob);

                const player = el('audioPlayer');
                player.src = audioUrl;
                
                // Finish Progress
                clearInterval(audioInterval);
                progressBar.style.width = '100%';
                progressText.innerText = "Audio Ready! (Duration: ~6 mins)";
                
                // Slight delay before showing player
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    player.classList.remove('hidden');
                    player.play();
                }, 1000);

            } catch (err) {
                // Clear intervals on error
                if (scriptInterval) clearInterval(scriptInterval);
                if (audioInterval) clearInterval(audioInterval);
                
                progressContainer.classList.add('hidden');
                console.error(err);
                alert("Audio generation failed: " + err.message);
            } finally {
                btn.disabled = false;
            }
        });

        // FOLLOW UP
        followUpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const q = el('followUpInput').value;
            const container = el('followUpResult');
            
            container.innerHTML = '<span class="animate-pulse">Dr. Holtkamp is thinking...</span>';
            container.classList.remove('hidden');

            const prompt = `
                Context: ${storedContext}
                User Question: "${q}"
                Role: Dr. Holtkamp.
                Task: Answer the question comparing the trials mentioned above if relevant. Be concise.
            `;

            try {
                const data = await fetchWithRetry(GENERATE_URL, {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ google_search: {} }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                });
                const rawFollowUp = data.candidates[0].content.parts[0].text;
                container.innerHTML = marked.parse(stripLatex(rawFollowUp)); // Apply cleaner here too
            } catch (err) {
                container.innerText = "Error getting response.";
            }
        });

        // Utilities
        function showLoader(text) {
            el('loaderText').innerText = text;
            el('loader').classList.remove('hidden');
        }
        function hideLoader() {
            el('loader').classList.add('hidden');
        }
        
        el('btnCopy').onclick = () => {
            navigator.clipboard.writeText(storedSummary);
            alert("Summary copied!");
        };
        el('btnPlan').onclick = () => {
            navigator.clipboard.writeText(el('planContent').innerText);
            alert("Plan copied!");
        };

    </script>
</body>
</html>
