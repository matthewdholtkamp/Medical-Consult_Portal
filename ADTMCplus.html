<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sick Call Consult</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Subtle scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Simple loading spinner */
        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 70px;
            height: 40px;
        }
        .loader > div {
            width: 12px;
            height: 12px;
            background-color: #818cf8; /* Indigo-300 */
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
            margin: 0 4px;
        }
        .loader .bounce1 {
            animation-delay: -0.32s;
        }
        .loader .bounce2 {
            animation-delay: -0.16s;
        }
        
        /* Follow-up loader styling */
        #follow-up-loader .loader {
            width: 50px;
            height: 24px;
        }
        #follow-up-loader .loader > div {
            width: 8px;
            height: 8px;
            margin: 0 2px;
        }

        /* Styling for the rendered consult output */
        #consult-output h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #a5b4fc; /* indigo-300 */
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #475569;
            padding-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        #consult-output strong {
            font-weight: 700;
            color: #f1f5f9;
        }
        #consult-output ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            color: #cbd5e1;
        }
        #consult-output li {
            margin-bottom: 0.25rem;
        }
        #consult-output p {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #e2e8f0;
        }
        
        /* Microphone Button Styles */
        .mic-btn {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 6px;
            border: none;
            border-radius: 50%;
            background-color: #334155;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #475569;
        }
        .mic-btn:hover {
            background-color: #475569;
            color: white;
        }
        .mic-btn.is-listening {
            background-color: #dc2626;
            color: white;
            border-color: #ef4444;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); } 
            40% { transform: scale(1.0); }
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 dark:text-gray-300 selection:bg-sky-500 selection:text-white min-h-screen">

    <!-- =================================================================== -->
    <!-- DISCLAIMER MODAL -->
    <!-- =================================================================== -->
    <div id="disclaimerModal"
         role="dialog"
         aria-modal="true"
         aria-labelledby="disclaimerTitle"
         aria-describedby="disclaimerDesc"
         class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 transition-opacity duration-300">
      
      <!-- Dialog container -->
      <div id="disclaimerDialog"
           class="w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-2xl bg-slate-800 border border-slate-700 p-6 text-left text-slate-100 shadow-2xl ring-1 ring-white/10"
           tabindex="-1">
           
        <!-- Header -->
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 id="disclaimerTitle" class="text-2xl font-bold mb-1 text-white">Quick challenge — one small step</h2>
            <p class="text-sm text-slate-400">Use only de-identified examples. You'll be prompted if something looks like PHI.</p>
          </div>
          <div class="hidden sm:inline-flex items-center gap-2 text-sm">
            <span class="inline-block px-2.5 py-0.5 rounded-full bg-amber-500/10 text-amber-500 border border-amber-500/20 font-medium text-xs uppercase tracking-wider">Safety First</span>
          </div>
        </div>

        <hr class="my-4 border-slate-700/60"/>

        <!-- Main message -->
        <p id="disclaimerDesc" class="text-sm text-slate-300 mb-3 leading-relaxed">
          This site generates consult drafts and provides clinical decision support. It does <strong>not</strong> replace your clinical judgment,
          licensure, or medical decision-making. Enter only de-identified information here.
        </p>

        <div class="bg-amber-950/30 border-l-4 border-amber-500 p-3 mb-4 rounded-r">
            <p class="text-sm font-semibold text-amber-200">
            This platform is <u>NOT HIPAA compliant</u>. Do <strong>NOT</strong> enter Protected Health Information (PHI).
            </p>
        </div>

        <p class="text-sm mb-2 font-medium text-slate-200">Do not enter any of the following 18 direct identifiers (HIPAA Safe Harbor):</p>

        <div class="bg-slate-900/50 rounded-lg p-4 mb-4 border border-slate-700/50">
            <ol class="list-decimal list-inside text-xs sm:text-sm space-y-1 text-slate-400 grid grid-cols-1 sm:grid-cols-2 gap-x-4">
            <li>Names (Full or initials)</li>
            <li>Geographic subdivisions &lt; State</li>
            <li>Dates (except year) & Ages &gt; 89</li>
            <li>Telephone numbers</li>
            <li>Fax numbers</li>
            <li>Email addresses</li>
            <li>Social Security numbers</li>
            <li>Medical record numbers</li>
            <li>Health plan beneficiary #s</li>
            <li>Account numbers</li>
            <li>Certificate/license numbers</li>
            <li>Vehicle identifiers/plates</li>
            <li>Device identifiers/serials</li>
            <li>Web URLs</li>
            <li>IP addresses</li>
            <li>Biometric identifiers</li>
            <li>Full-face photos/images</li>
            <li>Any other unique numbers/codes</li>
            </ol>
        </div>

        <p class="text-sm font-semibold text-slate-200 mb-2">Additional — other details that can identify a person:</p>
        <ul class="list-disc list-inside text-sm mb-4 text-slate-400 space-y-1">
          <li>Unique combinations of demographics or clinical details (rare diagnosis + exact timestamp/location).</li>
          <li>Occupation with a unique role/location (e.g., "the hospital CEO" at a small facility).</li>
          <li>Free-text notes with household details, quoted speech, or local references that link to an individual.</li>
        </ul>

        <!-- Acknowledgement controls -->
        <div class="flex flex-col gap-4 mt-6 pt-4 border-t border-slate-700/60">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <div class="space-y-2">
                <label class="flex items-center gap-3 cursor-pointer group">
                    <div class="relative flex items-center">
                        <input id="ackCheckbox" type="checkbox" class="peer h-5 w-5 rounded border-slate-600 bg-slate-700 text-amber-500 focus:ring-amber-500/50 focus:ring-offset-0 transition-all" />
                    </div>
                    <span class="text-sm text-slate-300 group-hover:text-white transition-colors">I confirm I will not enter PHI or identifiable information.</span>
                </label>

                <label class="flex items-center gap-3 cursor-pointer group">
                    <div class="relative flex items-center">
                        <input id="dontShowAgain" type="checkbox" class="peer h-5 w-5 rounded border-slate-600 bg-slate-700 text-sky-500 focus:ring-sky-500/50 focus:ring-offset-0 transition-all" />
                    </div>
                    <span class="text-sm text-slate-300 group-hover:text-white transition-colors">Don't show this again on this device</span>
                </label>
              </div>

              <button id="ackBtn"
                      onclick="acceptDisclaimer()"
                      disabled
                      class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-2.5 rounded-xl bg-amber-600 text-white font-semibold shadow-lg shadow-amber-900/20 hover:bg-amber-500 hover:scale-[1.02] focus:ring-4 focus:ring-amber-500/30 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:shadow-none">
                I Understand — Continue
              </button>
          </div>
          
          <p class="text-xs text-center sm:text-right text-slate-500">By continuing you acknowledge this tool is for support only.</p>
        </div>
      </div>
    </div>

    <!-- =================================================================== -->
    <!-- HERO SECTION -->
    <!-- =================================================================== -->
    <header class="relative overflow-hidden rounded-b-3xl mb-8 shadow-2xl border-b border-white/5">

      <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-gray-900 -z-10"></div>
      
      <!-- Decorative background elements -->
      <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full max-w-7xl pointer-events-none overflow-hidden">
          <div class="absolute top-[-20%] right-[-10%] w-[600px] h-[600px] rounded-full bg-blue-600/10 blur-[100px]"></div>
          <div class="absolute bottom-[-20%] left-[-10%] w-[500px] h-[500px] rounded-full bg-indigo-600/10 blur-[80px]"></div>
      </div>

      <div class="relative max-w-4xl mx-auto px-6 py-12 sm:py-16 text-center">
          
          <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 backdrop-blur-md mb-6">
              <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
              <span class="text-xs font-medium text-slate-300 uppercase tracking-wide">System Operational</span>
          </div>

          <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-white via-slate-200 to-slate-400 leading-tight tracking-tight mb-4 drop-shadow-lg">
              AI Sick Call Consult
          </h1>

          <p class="max-w-2xl mx-auto text-lg sm:text-xl text-slate-300/90 font-medium leading-relaxed">
              Standardized Note & Profile Generator<br>
              <span class="text-white/60">Decision support for Medics & Providers.</span>
          </p>
      </div>
    </header>

    <!-- =================================================================== -->
    <!-- MAIN APP CONTAINER -->
    <!-- =================================================================== -->
    <div class="container mx-auto px-4 pb-24 max-w-5xl">
        
        <main class="bg-white dark:bg-slate-800/50 dark:border dark:border-slate-700/50 rounded-2xl p-6 sm:p-8 shadow-2xl relative backdrop-blur-sm">

            <!-- Speech Error Message -->
            <div id="speech-error" class="hidden bg-amber-950/30 border-l-4 border-amber-500 text-amber-200 p-4 rounded-md mb-6" role="alert">
                <p class="font-bold">Microphone Error</p>
                <p id="speech-error-message" class="text-sm opacity-90">Could not start dictation.</p>
            </div>

            <!-- Step 1: De-identified Intake -->
            <div id="step-1-intake">
                <div class="flex justify-between items-center mb-6 border-b border-slate-700/50 pb-4">
                    <h2 class="text-2xl font-bold text-slate-100">1) De-identified Intake</h2>
                    <button id="start-over-1" class="text-sm text-indigo-400 hover:text-indigo-300 hover:underline transition-colors">Start Over</button>
                </div>
                
                <form id="intake-form-1" class="space-y-6">
                    <!-- Content is dynamically injected by JavaScript -->
                </form>
            </div>

            <!-- Step 2: AI-Guided Intake (Data/Exam) -->
            <div id="step-2-questions" class="hidden">
                <div class="flex justify-between items-center mb-6 border-b border-slate-700/50 pb-4">
                    <h2 class="text-2xl font-bold text-slate-100">2) AI-Guided Intake (Data & Exam)</h2>
                    <button id="start-over-2" class="text-sm text-indigo-400 hover:text-indigo-300 hover:underline transition-colors">Start Over</button>
                </div>
                
                <form id="intake-form-2" class="space-y-6">
                    <!-- Content is dynamically injected by JavaScript -->
                </form>
            </div>

            <!-- Step 3: AI Sick Call Assessment -->
            <div id="step-3-consult" class="hidden">
                <div class="flex justify-between items-center mb-6 border-b border-slate-700/50 pb-4">
                    <h2 class="text-2xl font-bold text-slate-100">3) Final Consult Note</h2>
                    <button id="start-over-3" class="text-sm text-indigo-400 hover:text-indigo-300 hover:underline transition-colors">Start Over</button>
                </div>
                
                <!-- Loading Spinner -->
                <div id="loading-spinner" class="flex flex-col items-center justify-center min-h-[300px]">
                    <div class="loader">
                        <div class="bounce1"></div>
                        <div class="bounce2"></div>
                        <div class="bounce3"></div>
                    </div>
                    <p class="text-slate-400 mt-4 font-medium animate-pulse">Drafting assessment and profile instructions...</p>
                </div>
                
                <!-- Consult Output -->
                <div id="consult-output-container" class="hidden">
                    <div id="consult-output" class="bg-slate-900/80 p-6 rounded-xl border border-slate-700/60 min-h-[200px] text-slate-300 shadow-inner">
                    <!-- AI content will be injected here -->
                    </div>
                </div>

                <!-- NEW: Follow-up Addendum Area -->
                <div id="follow-up-addendum-area" class="hidden mt-6 space-y-4">
                    <!-- Follow-up Q&A will be injected here -->
                </div>

                <!-- Military Profile Section -->
                <div id="military-profile-section" class="hidden mt-8 pt-8 border-t border-slate-700/60">
                    <h3 class="text-xl font-bold text-indigo-400 uppercase tracking-wide mb-6 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-indigo-500 rounded-full"></span>
                        Profile Generator (DA 3349)
                    </h3>
                    
                    <div class="grid gap-6">
                        <!-- 1. Commander Section -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Instructions for Commander</label>
                            <div id="profile-commander-output" class="bg-slate-900/80 p-4 rounded-xl border border-slate-700/60 min-h-[80px] text-slate-300 shadow-inner"></div>
                        </div>
                        <!-- 2. Soldier Section -->
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Instructions to Soldier</label>
                            <div id="profile-soldier-output" class="bg-slate-900/80 p-4 rounded-xl border border-slate-700/60 min-h-[80px] text-slate-300 shadow-inner"></div>
                        </div>
                        <!-- 3. Profile Days Section -->
                        <div>
                            <label for="profile-days" class="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Profile Duration (Days)</label>
                            <input type="number" id="profile-days" min="0" class="block w-32 bg-slate-900 border border-slate-700 text-slate-200 placeholder-slate-500 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 transition-all" placeholder="e.g., 3">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Follow-up Section -->
            <div id="follow-up-section" class="hidden mt-8 pt-8 border-t border-slate-700/60">
                <h3 class="text-lg font-semibold text-slate-100 mb-3">Consult Refinement</h3>
                <label for="follow-up-input" class="block text-sm font-medium text-slate-400 mb-2">Ask the AI to adjust the plan, explain the diagnosis, or check interactions:</label>
                <div class="relative">
                    <textarea id="follow-up-input" rows="2" class="block w-full bg-slate-900 border border-slate-700 text-slate-200 placeholder-slate-500 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 pr-24 transition-all"></textarea>
                    <div class="absolute bottom-2 right-2 flex items-center gap-2">
                        <div id="follow-up-loader" class="hidden">
                            <div class="loader scale-75">
                                <div class="bounce1"></div>
                                <div class="bounce2"></div>
                                <div class="bounce3"></div>
                            </div>
                        </div>
                        <button type="button" id="submit-follow-up-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-semibold py-1.5 px-3 rounded-lg shadow-lg shadow-indigo-900/20 transition-all hover:scale-105">
                            Update
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Buttons (Copy/Back) -->
            <div id="bottom-buttons" class="hidden pt-8 mt-4 border-t border-slate-700/60 flex flex-col sm:flex-row justify-between gap-4">
                <button type="button" id="back-to-step-2-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-200">
                    &larr; Back
                </button>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="button" id="copy-clipboard-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-3 px-6 rounded-xl shadow-lg shadow-emerald-900/20 transition-all duration-200 hover:scale-[1.02]">
                        Copy Full Note
                    </button>
                    <div id="copy-success" class="text-emerald-400 text-sm items-center justify-center flex hidden font-bold animate-pulse">Copied!</div>
                </div>
            </div>

        </main>
    </div>

    <!-- Hidden Textarea for Copy-to-Clipboard -->
    <textarea id="clipboard-helper" class="absolute -left-full"></textarea>

    <script>
    /* ====== DISCLAIMER MODAL BEHAVIOR ====== */
    (function() {
      const MODAL_KEY = 'consultDisclaimerAck_v1';
      const AUDIT_KEY = 'consultDisclaimerAudit_v1';
      const modal = document.getElementById('disclaimerModal');
      const dialog = document.getElementById('disclaimerDialog');
      const ackCheckbox = document.getElementById('ackCheckbox');
      const ackBtn = document.getElementById('ackBtn');
      const dontShowAgain = document.getElementById('dontShowAgain');
    
      // Check persistence
      try {
        const prev = localStorage.getItem(MODAL_KEY);
        if (prev) {
          if (modal) modal.style.display = 'none';
          return;
        }
      } catch (e) {
        console.warn('localStorage not available for disclaimer persistence.');
      }
    
      // Lock background scroll
      document.body.style.overflow = 'hidden';
      
      // Focus management
      if(dialog) dialog.focus();
      if(ackCheckbox) ackCheckbox.focus();
    
      // Button state
      ackCheckbox?.addEventListener('change', () => {
        if (ackCheckbox.checked) {
          ackBtn.disabled = false;
          ackBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
          ackBtn.disabled = true;
          ackBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      });
    
      // Modal trap
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) e.stopPropagation();
      });
    
      // Focus Trap Logic
      const FOCUSABLE_SELECTORS = 'a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"])';
      function trapFocus(e) {
        const focusable = Array.from(dialog.querySelectorAll(FOCUSABLE_SELECTORS)).filter(el => el.offsetParent !== null);
        if (focusable.length === 0) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (e.key === 'Tab') {
          if (e.shiftKey) { 
            if (document.activeElement === first) {
              e.preventDefault();
              last.focus();
            }
          } else { 
            if (document.activeElement === last) {
              e.preventDefault();
              first.focus();
            }
          }
        }
      }
      window.addEventListener('keydown', trapFocus);
    
      // Prevent Escape
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') e.preventDefault();
      });
    
      // Accept function
      window.acceptDisclaimer = function() {
        try {
          const now = new Date().toISOString();
          const auditRaw = localStorage.getItem(AUDIT_KEY);
          const audits = auditRaw ? JSON.parse(auditRaw) : [];
          audits.push({ ts: now });
          localStorage.setItem(AUDIT_KEY, JSON.stringify(audits));
    
          if (dontShowAgain && dontShowAgain.checked) {
            localStorage.setItem(MODAL_KEY, now);
          }
        } catch (err) {
          console.warn('localStorage unavailable; audit/persistence may not be recorded.');
        }
    
        if (modal) {
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        document.body.style.overflow = '';
        window.removeEventListener('keydown', trapFocus);
      };
    })();
    </script>

    <script type="module">
        // --- Gemini API Configuration ---
        const API_KEY = "AIzaSyAyAQ96QdTF4b2rRn_yMQ8O4poLOtzz72o";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // --- State Management ---
        const state = {
            hpi: '',
            pmh: '',
            psh: '',
            allergies: '',
            medications: '',
            ros_general: '',
            unit_mos: '', 
            opqrst: '',
            exam: '',
            point_of_care_tests: '',
            labs: '',
            imaging: ''
        };
        let chatHistory = []; 
        
        // --- Speech Recognition State ---
        let recognition;
        let activeTextarea = null;
        let lastTranscript = ''; 
        let baseTranscript = ''; 
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        // --- UI Element References ---
        const steps = {
            1: document.getElementById('step-1-intake'),
            2: document.getElementById('step-2-questions'),
            3: document.getElementById('step-3-consult')
        };
        
        const loader = document.getElementById('loading-spinner');
        const consultOutputContainer = document.getElementById('consult-output-container');
        const consultOutput = document.getElementById('consult-output');
        const copySuccessMessage = document.getElementById('copy-success');
        const bottomButtons = document.getElementById('bottom-buttons');

        // --- Step Navigation ---
        function showStep(stepNumber) {
            Object.values(steps).forEach(step => step.classList.add('hidden'));
            if (steps[stepNumber]) {
                steps[stepNumber].classList.remove('hidden');
            }
            // Hide bottom buttons unless on step 3
            bottomButtons.classList.toggle('hidden', stepNumber !== 3);
            window.scrollTo(0, 0); 
        }

        // --- Data Collection ---
        function saveStep1Data() {
            state.hpi = document.getElementById('hpi').value;
            state.pmh = document.getElementById('pmh').value;
            state.psh = document.getElementById('psh').value;
            state.allergies = document.getElementById('allergies').value;
            state.medications = document.getElementById('medications').value;
            state.ros_general = document.getElementById('ros_general').value;
            state.unit_mos = document.getElementById('unit_mos').value;
        }

        function saveStep2Data() {
            state.opqrst = document.getElementById('opqrst').value;
            state.exam = document.getElementById('exam').value;
            state.point_of_care_tests = document.getElementById('point_of_care_tests').value;
            state.labs = document.getElementById('labs').value;
            state.imaging = document.getElementById('imaging').value;
        }

        // --- AI Consult Logic ---
        function buildConsultPrompt() {
            const addSection = (title, data) => data ? `**${title}:**\n${data}\n\n` : '';

            // --- UPDATED SYSTEM PROMPT FOR CONSULT NOTE FORMAT ---
            const systemPrompt = `You are an AI decision support tool for a U.S. Army Medic (68W) at a Sick Call clinic.
**PRIMARY GOAL:**
Generate a professional, clinically accurate consult note using the standard Assessment and Plan format.

**CRITICAL FORMATTING INSTRUCTIONS:**
1. **Assessment (Paragraph):** You must generate a cohesive narrative paragraph. Synthesize the Soldier's Unit/MOS, Age/Sex, Chief Complaint, Key Exam Findings, and Diagnosis into one professional summary. Explicitly mention if Red Flags are present or absent in this paragraph.
2. **Plan (Bullets):** You must generate a clear, bulleted list of actions, including medications (dose/freq), non-pharm interventions (ice, rest), patient education, and disposition (RTD vs Quarters).
3. **Military Profile:** You must generate actionable bullet points for DA Form 3349.
4. **Style:** Use plain English. No LaTeX. No Charts.

**REQUIRED OUTPUT STRUCTURE:**
Your response MUST follow this exact structure:

## Assessment
(Write a single narrative paragraph here. Example: "24-year-old male Infantryman (11B) presenting with acute right ankle pain following an inversion injury. Physical exam reveals edema and tenderness over the ATFL with a negative squeeze test, consistent with a Grade 1 lateral ankle sprain. No red flags for fracture or neurovascular compromise were identified.")

## Plan
(Bulleted list)
* **Medications:** (e.g., Ibuprofen 800mg PO TID x 5 days)
* **Treatment:** (e.g., RICE protocol, ace wrap)
* **Education:** (e.g., Return to clinic if pain worsens or unable to bear weight)
* **Disposition:** (e.g., Quarters for 24 hours, then RTD)

<!-- This is the consult break string -->
CONSULT_BREAK_COMMANDER
## Commander Instructions (Profile Limits)
(3-5 short bullets on functional limitations. e.g., No running, No rucking > 35lbs)

<!-- This is the commander break string -->
COMMANDER_BREAK_SOLDIER
## Soldier Instructions (Education)
(3-5 simple bullets for the patient. e.g., Keep ice on for 20 mins every 2 hours.)
`;

            const userPrompt = `
**SICK CALL ENCOUNTER**
${addSection('Soldier Unit & MOS', state.unit_mos)}
${addSection('Chief Complaint & HPI', state.hpi)}
${addSection('Symptom Details (OPQRST)', state.opqrst)}
${addSection('Past Medical History', state.pmh)}
${addSection('Past Surgical History', state.psh)}
${addSection('Allergies', state.allergies)}
${addSection('Medications', state.medications)}
${addSection('General ROS', state.ros_general)}
${addSection('Vital Signs & Physical Exam', state.exam)}
${addSection('Point-of-Care Tests', state.point_of_care_tests)}
${addSection('Other Labs', state.labs)}
${addSection('Imaging Findings', state.imaging)}
`;
            return { systemPrompt, userPrompt };
        }

        async function fetchConsult() {
            saveStep2Data(); 
            showStep(3);
            loader.classList.remove('hidden');
            consultOutputContainer.classList.add('hidden');
            document.getElementById('military-profile-section').classList.add('hidden');
            document.getElementById('follow-up-section').classList.add('hidden');
            document.getElementById('follow-up-addendum-area').classList.add('hidden');


            const { systemPrompt, userPrompt } = buildConsultPrompt();
            
            chatHistory = [{ role: "user", parts: [{ text: userPrompt }] }];

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                tools: [{ "google_search": {} }],
                generationConfig: {
                    temperature: 0.2, 
                    topK: 40,
                }
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }
                
                const result = await response.json();
                const candidate = result.candidates?.[0];
                
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const rawText = candidate.content.parts[0].text;
                    
                    chatHistory.push({ role: "model", parts: [{ text: rawText }] });

                    const parts = rawText.split(/CONSULT_BREAK_COMMANDER|COMMANDER_BREAK_SOLDIER/);
                    const consultNoteText = parts[0] || "<p class='text-red-500'>Error: Failed to parse consult note.</p>";
                    const commanderText = parts[1] || "<p class='text-red-500'>Error: Failed to parse commander instructions.</p>";
                    const soldierText = parts[2] || "<p class='text-red-500'>Error: Failed to parse soldier instructions.</p>";

                    // Render medical note
                    let consultHtml = simpleMarkdownToHtml(consultNoteText);

                    // Handle grounding metadata
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        const sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);

                        if (sources.length > 0) {
                            consultHtml += `<div class="mt-4 pt-4 border-t border-slate-700/60"><h2 class="text-xs text-indigo-400 uppercase mb-2 font-bold tracking-wider">References</h2><ul class="text-xs text-slate-400 space-y-1">`;
                            sources.forEach(source => {
                                consultHtml += `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="hover:text-indigo-300 underline transition-colors">${source.title}</a></li>`;
                            });
                            consultHtml += `</ul></div>`;
                        }
                    }
                    
                    consultOutput.innerHTML = consultHtml;
                    document.getElementById('profile-commander-output').innerHTML = simpleMarkdownToHtml(commanderText);
                    document.getElementById('profile-soldier-output').innerHTML = simpleMarkdownToHtml(soldierText);
                } else {
                    consultOutput.innerHTML = "<p class='text-red-400'>Error: Invalid API response.</p>";
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                consultOutput.innerHTML = `<p class='text-red-400'><strong>Connection Error:</strong><br>${error.message}</p>`;
            } finally {
                loader.classList.add('hidden');
                consultOutputContainer.classList.remove('hidden');
                document.getElementById('military-profile-section').classList.remove('hidden');
                document.getElementById('follow-up-section').classList.remove('hidden');
            }
        }
        
        // --- Exponential Backoff Retry ---
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 || response.status >= 500) { 
                    if (retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(url, options, retries - 1, delay * 2);
                    } else {
                        throw new Error("API request failed after multiple retries.");
                    }
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }

        // --- Handle Follow-up Questions ---
        async function handleFollowUp() {
            const input = document.getElementById('follow-up-input');
            const followUpText = input.value.trim();
            if (!followUpText) return;

            const loader = document.getElementById('follow-up-loader');
            const button = document.getElementById('submit-follow-up-btn');

            loader.classList.remove('hidden');
            button.disabled = true;
            input.disabled = true;

            chatHistory.push({ role: "user", parts: [{ text: followUpText }] });
            
            // UPDATED FOLLOW-UP PROMPT TO MAINTAIN NEW FORMAT
            const followUpSystemPrompt = `You are the same AI Senior Medic/PA.
The user is asking for an update or clarification to the consult note.

**CRITICAL INSTRUCTIONS:**
1. If the user asks to change the plan or meds, **Rewrite the Plan section** in the bulleted format established previously.
2. If the user asks to change the profile, update the Commander Instructions.
3. Keep answers concise.

**REQUIRED FORMAT:**
## Update to Assessment/Plan
(Your direct answer. If updating the plan, provide the full updated bulleted list here.)

<!-- This is the consult break string -->
CONSULT_BREAK_COMMANDER

## Updated Commander Instructions
(Provide updated bullets or state "No change to profile.")

<!-- This is the commander break string -->
COMMANDER_BREAK_SOLDIER

## Updated Soldier Instructions
(Provide updated bullets or state "No change to patient instructions.")
`;
            
            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: followUpSystemPrompt }] 
                },
                tools: [{ "google_search": {} }],
                generationConfig: {
                    temperature: 0.2,
                    topK: 40,
                }
            };

            try {
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const rawText = candidate.content.parts[0].text;
                    
                    chatHistory.push({ role: "model", parts: [{ text: rawText }] });

                    const parts = rawText.split(/CONSULT_BREAK_COMMANDER|COMMANDER_BREAK_SOLDIER/);
                    const consultFollowUpText = parts[0] || "Error";
                    const newCommanderText = parts[1] || "Error";
                    const newSoldierText = parts[2] || "Error";

                    let followUpHtml = simpleMarkdownToHtml(consultFollowUpText);
                    
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        const sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                            .filter(source => source.uri && source.title);
                        if (sources.length > 0) {
                            followUpHtml += `<div class="mt-2 text-xs text-slate-500">Sources: `;
                            sources.forEach(source => {
                                followUpHtml += `<a href="${source.uri}" target="_blank" class="underline mr-2 hover:text-slate-300 transition-colors">${source.title}</a>`;
                            });
                            followUpHtml += `</div>`;
                        }
                    }
                    
                    const addendumContainer = document.getElementById('follow-up-addendum-area');
                    if (addendumContainer.classList.contains('hidden')) {
                        addendumContainer.classList.remove('hidden');
                        addendumContainer.innerHTML = `<h3 class="text-xl font-semibold text-slate-100 mb-3 border-b border-slate-600 pb-2">Consult Updates</h3>`;
                    }

                    const qaBlock = `
                        <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg mb-4">
                            <p class="text-indigo-400 text-sm font-bold uppercase mb-2 tracking-wide">Update Request: "${escapeHTML(followUpText)}"</p>
                            <div class="mt-2 text-slate-300 prose prose-invert prose-sm max-w-none">${followUpHtml}</div>
                        </div>
                    `;
                    
                    addendumContainer.innerHTML += qaBlock;

                    if (!newCommanderText.includes("No change")) {
                        document.getElementById('profile-commander-output').innerHTML = simpleMarkdownToHtml(newCommanderText);
                    }
                    if (!newSoldierText.includes("No change")) {
                        document.getElementById('profile-soldier-output').innerHTML = simpleMarkdownToHtml(newSoldierText);
                    }
                    
                    input.value = '';
                    consultOutputContainer.scrollTop = consultOutputContainer.scrollHeight;

                } else {
                     console.error("Invalid follow-up response");
                }

            } catch (error) {
                console.error("Follow-up Fetch Error:", error);
            } finally {
                loader.classList.add('hidden');
                button.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        // --- Speech Recognition ---
        function initializeSpeechRecognition() {
            if (!SpeechRecognition) {
                console.warn("Speech Recognition API not supported in this browser.");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                if (!activeTextarea) return;

                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                activeTextarea.value = baseTranscript + finalTranscript + interimTranscript;
                
                if (finalTranscript) {
                    baseTranscript += finalTranscript + ' ';
                }
            };

            recognition.onend = () => {
                const currentActiveTextareaId = activeTextarea?.id;
                activeTextarea = null;
                lastTranscript = ''; 
                baseTranscript = ''; 

                if (currentActiveTextareaId) {
                    const micBtn = document.querySelector(`.mic-btn[data-target-id="${currentActiveTextareaId}"]`);
                    if (micBtn) {
                        micBtn.classList.remove('is-listening');
                        micBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>`;
                    }
                }
            };

            recognition.onerror = (event) => {
                const errorDiv = document.getElementById('speech-error');
                const errorMessage = document.getElementById('speech-error-message');
                
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    errorMessage.innerText = "Microphone access denied. Check browser settings.";
                } else {
                    errorMessage.innerText = `Error: ${event.error}`;
                }
                errorDiv.classList.remove('hidden');
            };
        }

        function handleMicClick(event) {
            const btn = event.currentTarget;
            const targetId = btn.dataset.targetId;
            const targetTextarea = document.getElementById(targetId);

            if (!recognition || !targetTextarea) return;

            if (activeTextarea) { 
                recognition.stop();
            } else { 
                document.getElementById('speech-error').classList.add('hidden');
                
                lastTranscript = ''; 
                baseTranscript = targetTextarea.value;
                if (baseTranscript.length > 0 && !baseTranscript.endsWith(' ')) {
                    baseTranscript += ' ';
                }
                
                activeTextarea = targetTextarea;
                recognition.start();
                btn.classList.add('is-listening');
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`; 
            }
        }

        // --- Utility Functions ---
        function simpleMarkdownToHtml(md) {
            let html = md
                .replace(/^## (.*$)/gim, '<h2>$1</h2>') 
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/__(.*?)__/g, '<strong>$1</strong>'); 

            html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
            html = html.replace(/((<li>.*<\/li\>[\n\r]?)+)/g, '<ul>$1</ul>');

            let lines = html.split('\n');
            for (let i = 0; i < lines.length; i++) {
                if (!lines[i].startsWith('<h') && !lines[i].startsWith('<li') && !lines[i].startsWith('<ul') && !lines[i].endsWith('</ul>') && !lines[i].startsWith('<div') && lines[i].trim() !== '') {
                    lines[i] = `<p>${lines[i]}</p>`;
                }
            }
            return lines.join('\n').replace(/<p><\/p>/g, ''); 
        }

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[match];
            });
        }
        
        function copyToClipboard() {
            let textToCopy = `--- AI SICK CALL CONSULT ---\n\n`;
            textToCopy += consultOutput.innerText;

            const addendumArea = document.getElementById('follow-up-addendum-area');
            if (!addendumArea.classList.contains('hidden')) {
                textToCopy += `\n\n--- UPDATES ---\n`;
                const qaBlocks = addendumArea.querySelectorAll('.bg-slate-800');
                qaBlocks.forEach(block => {
                    textToCopy += block.innerText + "\n";
                });
            }

            textToCopy += `\n\n--- PROFILE INSTRUCTIONS (DA 3349) ---\n`;
            textToCopy += `COMMANDER: \n${document.getElementById('profile-commander-output').innerText}\n\n`;
            textToCopy += `SOLDIER: \n${document.getElementById('profile-soldier-output').innerText}\n\n`;
            textToCopy += `PROFILE DAYS: ${document.getElementById('profile-days').value || 'N/A'}\n`;
            textToCopy += `\n(Generated by ADTMC AI)`;

            const helper = document.getElementById('clipboard-helper');
            helper.value = textToCopy;
            helper.select();
            helper.setSelectionRange(0, 99999); 
            
            try {
                document.execCommand('copy');
                copySuccessMessage.classList.remove('hidden');
                setTimeout(() => {
                    copySuccessMessage.classList.add('hidden');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
        }

        function startOver() {
            if (recognition && activeTextarea) {
                recognition.stop();
            }
            document.getElementById('intake-form-1').reset();
            document.getElementById('intake-form-2').reset();
            
            const rosTextarea = document.getElementById('ros_general');
            if (rosTextarea) {
                rosTextarea.value = "Constitutional: \nHEENT: \nRespiratory: \nCardiovascular: \nGI: \nGU: \nMSK: \nNeuro: \nSkin: ";
            }
            consultOutput.innerHTML = '';
            
            chatHistory = [];
            document.getElementById('follow-up-section').classList.add('hidden');
            document.getElementById('follow-up-input').value = '';
            document.getElementById('follow-up-addendum-area').innerHTML = '';
            document.getElementById('follow-up-addendum-area').classList.add('hidden');

            document.getElementById('military-profile-section').classList.add('hidden');
            document.getElementById('profile-commander-output').innerHTML = '';
            document.getElementById('profile-soldier-output').innerHTML = '';
            document.getElementById('profile-days').value = '';

            showStep(1);
        }

        // --- Component Template ---
        function FormSection({ title, id, placeholder = '', rows = '3', value = '' }) {
            return `
                <div class="mb-6 group">
                    <label for="${id}" class="block text-sm font-medium text-slate-400 mb-2 transition-colors group-focus-within:text-indigo-400">${title}</label>
                    <div class="relative">
                        <textarea 
                            id="${id}" 
                            name="${id}" 
                            rows="${rows}" 
                            class="block w-full bg-slate-900 border border-slate-700 text-slate-200 placeholder-slate-600 rounded-xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 pr-12 transition-all hover:border-slate-600" 
                            placeholder="${placeholder}"
                        >${value}</textarea>
                        <button type="button" class="mic-btn absolute bottom-2 right-2" data-target-id="${id}" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="22"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // --- Event Listeners ---
        function registerEventListeners() {
            document.getElementById('back-to-step-2-btn').addEventListener('click', () => showStep(2));
            document.getElementById('copy-clipboard-btn').addEventListener('click', copyToClipboard);

            document.getElementById('start-over-1').addEventListener('click', startOver);
            document.getElementById('start-over-2').addEventListener('click', startOver);
            document.getElementById('start-over-3').addEventListener('click', startOver);
            
            document.getElementById('submit-follow-up-btn').addEventListener('click', handleFollowUp);
            document.getElementById('follow-up-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); 
                    handleFollowUp();
                }
            });

            const form1 = document.getElementById('intake-form-1');
            const form2 = document.getElementById('intake-form-2');
            
            form1.innerHTML = 
                FormSection({ title: "Chief Complaint & HPI:", id: "hpi", placeholder: "e.g., 21-year-old male with 3 days of cough, congestion, and low-grade fever. OR 30-year-old female reports rolling right ankle during PT...", rows: 5 }) +
                FormSection({ title: "Soldier's Unit & MOS:", id: "unit_mos", placeholder: "e.g., Infantry Unit / 11B OR Admin Unit / 42A", rows: 2 }) +
                `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">` +
                FormSection({ title: "Past Medical History (PMH):", id: "pmh", placeholder: "e.g., GERD, seasonal allergies.", rows: 4 }) +
                FormSection({ title: "Past Surgical History (PSH):", id: "psh", placeholder: "e.g., R-ACL repair (2022).", rows: 4 }) +
                `</div>` +
                `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">` +
                FormSection({ title: "Allergies:", id: "allergies", placeholder: "e.g., NKDA, Penicillin (rash)", rows: 3 }) +
                FormSection({ title: "Medications:", id: "medications", placeholder: "e.g., Loratadine 10mg PRN. OR None.", rows: 3 }) +
                `</div>` +
                FormSection({ 
                    title: "General ROS (pertinent):", 
                    id: "ros_general", 
                    placeholder: "Note pertinent positives/negatives", 
                    rows: 5, 
                    value: "Constitutional: \nHEENT: \nRespiratory: \nCardiovascular: \nGI: \nGU: \nMSK: \nNeuro: \nSkin: " 
                }) +
                `<div class="pt-6 flex justify-end">
                    <button type="button" id="go-to-step-2-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 px-8 rounded-xl shadow-lg shadow-indigo-900/20 transition-all hover:scale-105 duration-200">
                        Start Guided Exam &rarr;
                    </button>
                </div>`;
            
            form2.innerHTML = 
                FormSection({ title: "Symptom Details (OPQRST):", id: "opqrst", placeholder: "Onset, Palliating/Provoking, Quality, Radiation, Severity, Timing", rows: 3 }) +
                FormSection({ title: "Vital Signs & Physical Exam:", id: "exam", placeholder: "Vitals: T, P, R, BP, SpO2. Exam: (e.g., Lungs: CTA-B. Heart: RRR. Pharynx: Erythema, no exudate. OR e.g., MSK: R-ankle TTP over ATFL...)", rows: 5 }) +
                FormSection({ title: "Point-of-Care Tests (if any):", id: "point_of_care_tests", placeholder: "e.g., Rapid Strep: Neg. UDS: Neg. Pregnancy: Neg. Glucose: 95.", rows: 3 }) +
                FormSection({ title: "Other Labs:", id: "labs", placeholder: "e.g., CBC, BMP... (if drawn)", rows: 3 }) +
                FormSection({ title: "Imaging Findings (if any):", id: "imaging", placeholder: "e.g., Ankle X-ray (3-view): No acute fracture.", rows: 3 }) +
                `<div class="pt-6 flex justify-between items-center">
                    <button type="button" id="back-to-step-1-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-200">
                        &larr; Back
                    </button>
                    <button type="button" id="get-consult-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-semibold py-3 px-8 rounded-xl shadow-lg shadow-emerald-900/20 transition-all hover:scale-105 duration-200">
                        Generate Assessment
                    </button>
                </div>`;
                
            document.getElementById('go-to-step-2-btn').addEventListener('click', () => {
                saveStep1Data();
                showStep(2);
            });
            document.getElementById('back-to-step-1-btn').addEventListener('click', () => showStep(1));
            document.getElementById('get-consult-btn').addEventListener('click', fetchConsult);
            
            if (SpeechRecognition) {
                document.querySelectorAll('.mic-btn').forEach(btn => {
                    btn.style.display = 'inline-flex';
                    btn.addEventListener('click', handleMicClick);
                });
            }
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if (SpeechRecognition) {
                    initializeSpeechRecognition();
                }
                registerEventListeners();
                showStep(1); 
            } catch (error) {
                console.error("Initialization Error:", error);
            }
        });
    </script>
</body>
</html>
