<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADTMC+ SOAP Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4, summary, button { font-family: 'Roboto Condensed', sans-serif; letter-spacing: 0.5px; }
        .hidden { display: none !important; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px; height: 36px;
            border-radius: 50%;
            border-left-color: #F97316;
            animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { cursor: pointer; }
        
        .error-box { 
            display: none; 
            background-color: rgba(127, 29, 29, 0.5); 
            border: 1px solid #dc2626; 
            color: #fca5a5; 
            padding: 1rem; 
            border-radius: 0.375rem; 
            margin-bottom: 1rem; 
        }
        /* Only show if explicitly explicitly active via JS removing the hidden class, handled by utility class logic mostly */
        .error-box.active { display: block; }
        
        /* Custom Scrollbar for Note Preview */
        .note-preview::-webkit-scrollbar { width: 8px; }
        .note-preview::-webkit-scrollbar-track { background: #1f2937; }
        .note-preview::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-900 text-zinc-200">

    <div class="max-w-4xl mx-auto p-4 sm:p-8">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-orange-500">ADTMC + (The MAJ Russell Special)</h1>
            <p class="text-lg text-gray-300">Medic Decision Support & Documentation Tool</p>
        </header>

        <!-- HIPAA WARNING & CHECKLIST -->
        <details class="bg-red-900/50 border border-red-600 rounded-md mb-8">
            <summary class="font-semibold text-red-300 p-3 cursor-pointer text-lg flex justify-between items-center">
                <span>Click to Review: De-identified Data Only (HIPAA Warning)</span>
                <span class="text-xs bg-red-800 px-2 py-1 rounded border border-red-500">Required Check</span>
            </summary>
            <div class="p-4 border-t border-red-700 text-sm">
                <p class="font-bold text-red-200 mb-2">You MUST remove the following 18 identifiers:</p>
                <ul class="list-disc ml-5 space-y-1 text-red-300 grid grid-cols-1 md:grid-cols-2 gap-x-4">
                    <li>Names</li>
                    <li>Geographic subdivisions < State</li>
                    <li>Dates (except year)</li>
                    <li>Telephone #</li>
                    <li>Fax #</li>
                    <li>Email addresses</li>
                    <li>SSN</li>
                    <li>Medical Record #</li>
                    <li>Health Plan Beneficiary #</li>
                    <li>Account #</li>
                    <li>Certificate/License #</li>
                    <li>Vehicle IDs / Serial #</li>
                    <li>Device IDs / Serial #</li>
                    <li>Web URLs</li>
                    <li>IP Addresses</li>
                    <li>Biometric Identifiers</li>
                    <li>Full face photos</li>
                    <li>Any other unique ID number</li>
                </ul>
                <p class="mt-3 font-bold text-red-200">Do not enter unit specifics or unique events (e.g., "The Brigade Commander").</p>
            </div>
        </details>

        <!-- LOADING SPINNER -->
        <div id="loading-spinner" class="hidden flex justify-center items-center p-8">
            <div class="spinner"></div>
            <p class="ml-4 text-lg font-semibold text-gray-300">Processing Clinical Data...</p>
        </div>

        <!-- SECTION 1: CONSOLIDATED INTAKE -->
        <div id="section-intake" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-orange-500 border-b border-gray-700 pb-2">1. Initial Intake & Vitals</h2>
            <div id="error-message-intake" class="error-box hidden"></div>
            
            <form id="intake-form">
                
                <!-- Location Selection -->
                <div class="mb-6 bg-gray-900 p-3 rounded border border-gray-600">
                     <label for="location-input" class="block text-sm font-bold text-orange-400 mb-1 uppercase tracking-wide">Current Location of Interview</label>
                     <select id="location-input" class="w-full p-2 border border-gray-500 rounded bg-gray-800 text-white focus:ring-2 focus:ring-orange-500 outline-none">
                         <option value="CTMC">Consolidated Troop Medical Center (CTMC)</option>
                         <option value="BAS">Battalion Aid Station (BAS)</option>
                         <option value="ER">Emergency Room (ER)</option>
                         <option value="PCSL">Primary Care Clinic (PCSL)</option>
                     </select>
                </div>

                <!-- Chief Complaint Area -->
                <div class="mb-6">
                    <label for="initial-symptoms" class="block text-sm font-bold text-white mb-1">Chief Complaint & HPI Context (De-identified):</label>
                    <textarea id="initial-symptoms" rows="3" class="w-full p-3 border border-gray-600 rounded-md focus:ring-2 focus:ring-orange-500 focus:outline-none bg-gray-700 text-white placeholder-gray-400" placeholder="e.g., 24yo Male with R ankle pain after twisting it on a ruck march this morning. Swelling noted immediately."></textarea>
                    <div class="flex justify-end">
                        <button type="button" id="example-complaint-btn" class="mt-1 text-xs text-orange-400 hover:text-orange-300 underline">Load Example Case</button>
                    </div>
                </div>

                <!-- Vitals & History Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Vitals</label>
                        <textarea id="vitals-input" rows="2" class="w-full p-2 border border-gray-600 rounded-md bg-gray-900 text-white text-sm focus:border-orange-500 outline-none" placeholder="BP, HR, RR, Temp, SpO2"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Physical Exam / Initial Findings</label>
                        <textarea id="pe-input" rows="2" class="w-full p-2 border border-gray-600 rounded-md bg-gray-900 text-white text-sm focus:border-orange-500 outline-none" placeholder="Brief objective findings (e.g., TTP, ROM, swelling)"></textarea>
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Current Meds</label>
                        <input type="text" id="meds-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-900 text-white text-sm focus:border-orange-500 outline-none" placeholder="e.g., Lisinopril, Motrin">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Allergies</label>
                        <input type="text" id="allergies-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-900 text-white text-sm focus:border-orange-500 outline-none" placeholder="e.g., NKDA, Penicillin">
                    </div>
                    <div class="md:col-span-2">
                         <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Past Medical History (PMH)</label>
                         <input type="text" id="pmh-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-900 text-white text-sm focus:border-orange-500 outline-none" placeholder="e.g., HTN, Chronic Low Back Pain, Previous Surgeries">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Prior Labs / Imaging</label>
                        <input type="text" id="prior-labs-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-900 text-white text-sm focus:border-orange-500 outline-none" placeholder="Any relevant recent results">
                   </div>
                </div>

                <!-- Unified Action Button (Start) -->
                <button type="submit" class="w-full bg-orange-600 text-white font-bold text-lg py-4 px-6 rounded-lg shadow-lg border-2 border-orange-500 hover:bg-orange-500 hover:shadow-orange-500/40 transition-all transform hover:-translate-y-1 flex items-center justify-center">
                    <span class="mr-3">START AI INTERVIEW</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                </button>
                <p class="text-center text-xs text-gray-500 mt-2">Generates targeted follow-up questions based on the data above.</p>
            </form>
        </div>

        <!-- SECTION 2: AI QUESTIONS -->
        <div id="section-questions" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-orange-500 border-b border-gray-700 pb-2">2. Guided Intake Questions</h2>
            <p class="text-sm text-gray-400 mb-4">The AI has generated specific questions to clarify the case.</p>
            <div id="error-message-questions" class="error-box hidden"></div>
            <form id="questions-form">
                <div id="questions-container" class="space-y-4 mb-6"></div>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <!-- Unified Action Button (Back) -->
                    <button type="button" id="questions-back-btn" class="flex-1 bg-gray-700 text-gray-200 font-bold text-lg py-4 px-6 rounded-lg shadow-lg border-2 border-gray-600 hover:bg-gray-600 hover:text-white hover:border-gray-500 hover:shadow-gray-500/40 transition-all transform hover:-translate-y-1 flex items-center justify-center">
                        Back to Intake
                    </button>
                    <!-- Unified Action Button (Continue) -->
                    <button type="submit" class="flex-1 bg-orange-600 text-white font-bold text-lg py-4 px-6 rounded-lg shadow-lg border-2 border-orange-500 hover:bg-orange-500 hover:shadow-orange-500/40 transition-all transform hover:-translate-y-1 flex items-center justify-center">
                        Generate Plan
                    </button>
                </div>
            </form>
        </div>

        <!-- SECTION 3: PLAN REVIEW -->
        <div id="section-review" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
             <!-- Emergency Alert -->
             <div id="emergency-alert" class="hidden bg-red-900/50 border-l-4 border-red-600 text-red-300 p-4 rounded-md mb-6">
                <p class="font-bold flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    RED FLAG / TRIAGE ALERT
                </p>
                <p id="emergency-reason" class="mt-2 text-sm font-mono bg-red-900/30 p-2 rounded"></p>
            </div>

            <h2 class="text-xl font-semibold mb-4 text-orange-500 border-b border-gray-700 pb-2">3. Review & Select Plan Items</h2>
            <p class="text-sm text-gray-400 mb-4">Review the AI suggestions. Uncheck items to exclude them from the final note.</p>
            <div id="error-message-review" class="error-box hidden"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Col 1 -->
                <div class="space-y-4">
                    <div class="bg-gray-900 p-4 rounded border border-gray-700">
                        <h3 class="font-bold text-orange-400 mb-2 border-b border-gray-700 pb-1">Assessment</h3>
                        <p id="review-diagnosis" class="text-sm text-gray-200 mb-2 italic"></p>
                        <h4 class="text-xs font-bold text-gray-500 uppercase mt-2">Differential (DDx) & Probability</h4>
                        <ul id="review-ddx-list" class="text-sm text-gray-400 list-none space-y-1 mt-1"></ul>
                    </div>

                    <div class="bg-gray-900 p-4 rounded border border-gray-700">
                        <h3 class="font-bold text-orange-400 mb-2 border-b border-gray-700 pb-1">Workup (Labs/Rads/Consults)</h3>
                        <div id="review-workup-container" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Col 2 -->
                <div class="space-y-4">
                    <div class="bg-gray-900 p-4 rounded border border-gray-700">
                        <h3 class="font-bold text-orange-400 mb-2 border-b border-gray-700 pb-1">Treatment (Meds/Edu)</h3>
                        <div id="review-treatment-container" class="space-y-2"></div>
                    </div>

                    <div class="bg-gray-900 p-4 rounded border border-gray-700">
                        <h3 class="font-bold text-orange-400 mb-2 border-b border-gray-700 pb-1">Profile / Limitations</h3>
                        <div id="review-profile-container" class="space-y-2"></div>
                        <div class="mt-3 flex items-center bg-gray-800 p-2 rounded">
                             <label class="text-xs text-gray-400 mr-2 font-bold uppercase">Profile Duration (Days)</label>
                             <input type="number" id="profile-days" class="w-20 bg-gray-700 border border-gray-600 text-white text-center text-sm p-1 rounded focus:border-orange-500 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <!-- Unified Action Button (Back) -->
                <button type="button" id="review-back-btn" class="flex-1 bg-gray-700 text-gray-200 font-bold text-lg py-4 px-6 rounded-lg shadow-lg border-2 border-gray-600 hover:bg-gray-600 hover:text-white hover:border-gray-500 hover:shadow-gray-500/40 transition-all transform hover:-translate-y-1 flex items-center justify-center">
                    Back
                </button>
                <!-- Unified Action Button (Continue) -->
                <button type="button" id="review-continue-btn" class="flex-1 bg-orange-600 text-white font-bold text-lg py-4 px-6 rounded-lg shadow-lg border-2 border-orange-500 hover:bg-orange-500 hover:shadow-orange-500/40 transition-all transform hover:-translate-y-1 flex items-center justify-center">
                    Finalize Note
                </button>
            </div>
        </div>

        <!-- SECTION 4: REFINE & FINAL NOTE -->
        <div id="section-final" class="hidden bg-gray-800 p-6 rounded-lg shadow-md border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-orange-500 border-b border-gray-700 pb-2">4. Final SOAP Note</h2>
            
            <!-- Refinement / Q&A Box -->
            <div class="bg-gray-700 p-4 rounded-md mb-6 border border-gray-600">
                <label class="block text-sm font-bold text-orange-300 mb-2">Ask AI for Clarification or Adjustments</label>
                <div class="flex space-x-2">
                    <input type="text" id="refine-input" class="flex-1 p-2 bg-gray-900 border border-gray-600 rounded text-white text-sm focus:border-orange-500 outline-none" placeholder="e.g., 'What is the dose for Motrin?' or 'Why did you suggest X-Ray?'">
                    <button type="button" id="refine-btn" class="bg-orange-600 hover:bg-orange-500 text-white px-4 rounded font-medium text-sm transition-colors">Ask</button>
                </div>
                <div id="refine-response" class="hidden mt-3 p-3 bg-gray-800 rounded text-sm text-gray-300 border border-gray-600 italic"></div>
            </div>

            <!-- The Note -->
            <div class="bg-white text-black p-6 rounded-md shadow-inner max-h-[500px] overflow-y-auto note-preview font-mono text-sm leading-tight border-2 border-gray-400 mb-4">
                <pre id="final-note-content" class="whitespace-pre-wrap"></pre>
            </div>
            
            <button type="button" id="copy-note-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold text-lg py-4 px-6 rounded-lg shadow-lg border-2 border-gray-500 hover:shadow-gray-500/40 transition-all transform hover:-translate-y-1 flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                Copy Note to Clipboard
            </button>
            <p id="copy-success" class="hidden mt-2 text-center text-green-400 font-semibold text-sm">Copied successfully!</p>

            <!-- REFERENCES SECTION (NEW) -->
            <div id="references-container" class="bg-gray-900 p-4 rounded border border-gray-600 mb-8">
                <h3 class="text-orange-400 font-bold mb-2 border-b border-gray-700 pb-1 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" /></svg>
                    Clinical Evidence & References (Not included in Clipboard Copy)
                </h3>
                <p class="text-xs text-gray-500 mb-3">Links to guidelines and evidence supporting this plan.</p>
                <ul id="references-list" class="list-disc ml-5 text-sm space-y-2"></ul>
            </div>

            <div class="mt-6 flex justify-center">
                <button type="button" id="start-over-btn" class="text-gray-400 hover:text-white underline text-sm flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    Start Over (New Patient)
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- State Management ---
        let intakeState = {
            location: "",
            chiefComplaint: "",
            questions: [],
            answers: [],
            vitals: "",
            physicalExam: "",
            pmh: "",
            allergies: "",
            meds: "",
            priorLabs: "",
            generatedSoap: null
        };

        const apiKey = "AIzaSyBXI-KfP0oIIXXn6NHjznWPw62vcJdcXOQ";

        // --- DOM Elements ---
        const sections = {
            intake: document.getElementById('section-intake'),
            questions: document.getElementById('section-questions'),
            review: document.getElementById('section-review'),
            final: document.getElementById('section-final')
        };
        
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorBoxes = {
            intake: document.getElementById('error-message-intake'),
            questions: document.getElementById('error-message-questions'),
            review: document.getElementById('error-message-review')
        };

        // --- Navigation & UI Helpers ---
        function showLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            if (isLoading) Object.values(sections).forEach(s => s.classList.add('hidden'));
        }

        function showSection(name) {
            showLoading(false);
            Object.keys(sections).forEach(key => {
                sections[key].classList.toggle('hidden', key !== name);
            });
            window.scrollTo(0, 0);
        }

        function showError(section, msg) {
            if(errorBoxes[section]) {
                errorBoxes[section].textContent = msg;
                errorBoxes[section].classList.remove('hidden');
                errorBoxes[section].classList.add('active');
            }
        }
        
        function clearErrors() {
            Object.values(errorBoxes).forEach(box => {
                box.classList.add('hidden');
                box.classList.remove('active');
                box.textContent = '';
            });
        }

        // --- API Logic ---
        async function callGeminiApi(systemPrompt, userQuery, retries = 3) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (error) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, 1000));
                    return callGeminiApi(systemPrompt, userQuery, retries - 1);
                }
                throw error;
            }
        }

        async function callGeminiText(systemPrompt, userQuery) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
             const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            const response = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }


        // --- Step 1: Intake (CC + Data) ---
        document.getElementById('example-complaint-btn').addEventListener('click', () => {
            document.getElementById('initial-symptoms').value = "22M active duty soldier with right ankle pain. Twisted it during PT run this morning. Swollen, can bear weight but painful.";
            document.getElementById('vitals-input').value = "BP 124/78, HR 82, RR 16, 98% RA";
            document.getElementById('pe-input').value = "Swelling lateral malleolus. (+) Anterior Drawer. FROM. PMS Intact.";
            document.getElementById('meds-input').value = "None";
            document.getElementById('allergies-input').value = "NKDA";
            document.getElementById('pmh-input').value = "None";
        });

        document.getElementById('intake-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();

            const val = document.getElementById('initial-symptoms').value.trim();
            if(val.length < 5) return showError('intake', 'Please enter a valid Chief Complaint.');
            
            // Capture all data
            intakeState.location = document.getElementById('location-input').value;
            intakeState.chiefComplaint = val;
            intakeState.vitals = document.getElementById('vitals-input').value;
            intakeState.physicalExam = document.getElementById('pe-input').value;
            intakeState.pmh = document.getElementById('pmh-input').value;
            intakeState.allergies = document.getElementById('allergies-input').value;
            intakeState.meds = document.getElementById('meds-input').value;
            intakeState.priorLabs = document.getElementById('prior-labs-input').value;

            showLoading(true);

            try {
                // Prompt includes ALL context to make questions smarter
                const prompt = `
                    You are an expert combat medic assistant. 
                    Based on the Chief Complaint, Vitals, and History provided, generate 5-7 concise, targeted follow-up questions to build a complete HPI and ROS.
                    Do NOT ask for data already provided (e.g., if Vitals are present, don't ask for them).
                    Return strictly JSON: { "questions": ["Question 1", "Question 2"...] }
                `;
                
                const userContext = `
                    Current Location: ${intakeState.location}
                    Complaint: ${intakeState.chiefComplaint}
                    Vitals: ${intakeState.vitals}
                    Med Hx: ${intakeState.pmh}
                    Current Meds: ${intakeState.meds}
                    Allergies: ${intakeState.allergies}
                `;

                const result = await callGeminiApi(prompt, userContext);
                
                const container = document.getElementById('questions-container');
                container.innerHTML = '';
                result.questions.forEach((q, i) => {
                    container.innerHTML += `
                        <div>
                            <label class="block text-sm text-orange-300 mb-1 font-medium">${q}</label>
                            <input type="text" data-q="${q}" class="w-full p-2 border border-gray-600 rounded bg-gray-700 text-white focus:border-orange-500 outline-none" required>
                        </div>`;
                });
                showSection('questions');
            } catch (err) {
                console.error(err);
                showError('intake', 'Failed to generate questions. Please try again.');
                showSection('intake');
            }
        });

        // --- Step 2: Questions -> Plan Generation ---
        document.getElementById('questions-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();

            intakeState.answers = [];
            document.querySelectorAll('#questions-container input').forEach(inp => {
                intakeState.answers.push({ q: inp.dataset.q, a: inp.value });
            });

            showLoading(true);

            // Construct Full Context
            let context = `Location: ${intakeState.location}\nChief Complaint: ${intakeState.chiefComplaint}\n`;
            intakeState.answers.forEach(item => context += `Q: ${item.q} A: ${item.a}\n`);
            context += `\nVitals: ${intakeState.vitals}\nPhysical Exam: ${intakeState.physicalExam}\nPMH: ${intakeState.pmh}\nAllergies: ${intakeState.allergies}\nMeds: ${intakeState.meds}\nPrior Labs: ${intakeState.priorLabs}`;

            const systemPrompt = `
                You are an expert physician/PA assistant for the military. Generate a SOAP note structure.
                
                CRITICAL LOCATION-BASED TRIAGE LOGIC:
                1. The user is currently at: ${intakeState.location}.
                2. IF Location is 'CTMC', 'BAS', or 'PCSL' AND the patient requires emergency care (red flags, unstable, rule-out severe), the Disposition MUST recommended 'ER Transfer'.
                3. IF Location is 'ER' AND the patient requires expedited workup or admission, the Disposition MUST recommend 'Admission'.
                4. Otherwise, treat as standard outpatient or discharge with instructions.

                ADDITIONAL INSTRUCTIONS:
                - For each Differential Diagnosis (DDx), include a "likelihood" string using qualitative terms ONLY (e.g., "Very High", "High", "Medium", "Low", "Very Low"). Do NOT use percentages.
                - For each DDx, provide the specific "icd10" code.
                - PROFILE INSTRUCTION: Even if referring to ER/Specialist/Higher Care, ALWAYS provide the anticipated limitations/profile the patient will need upon discharge (e.g., "Quarters 24hrs", "Crutches", "No Running"). Do NOT state "N/A pending ER".
                - TREATMENT INSTRUCTIONS: Be very prescriptive with medications (Name, Dosage, Route, Frequency). Include Immediate/Acute options, Ongoing/Maintenance options (if applicable), and Alternatives. Prefix strings with context if helpful (e.g., "Acute: Toradol 30mg IM", "Maintenance: Lisinopril 10mg Daily").
                - WORKUP INSTRUCTIONS: Include Labs, Radiology, AND Consults/Referrals (e.g., "Consult Orthopedics", "Refer to Physical Therapy", "Refer to Cardiology").

                OUTPUT JSON ONLY with this exact schema:
                {
                    "subjective": {
                        "hpi_paragraph": "A complete paragraph narrative of the HPI.",
                        "ros_bullets": ["ROS point 1", "ROS point 2"]
                    },
                    "assessment": {
                        "synthesis_statement": "The most likely diagnosis and reasoning supported by evidence.",
                        "ddx": [
                            {"name": "Diagnosis Name", "icd10": "ICD-10 Code", "desc": "One sentence description of why.", "likelihood": "e.g. High, Medium, Low"}
                        ]
                    },
                    "plan": {
                        "disposition": "Triage recommendation (e.g., Maintain Outpatient, ER Transfer, Admission, etc)",
                        "is_emergency": boolean,
                        "emergency_reason": "string or null",
                        "workup": ["Lab 1", "X-Ray View", "Consult Name"],
                        "treatment": ["Medication Name & Dose", "Non-pharm intervention", "Education topic"],
                        "profile": {
                            "days": number,
                            "commander_limitations": ["Limitation 1", "Limitation 2"],
                            "soldier_instructions": ["Instruction 1"]
                        }
                    },
                    "references": [
                        {"title": "Title of the Guideline/Article", "url": "https://valid-url.com"}
                    ]
                }
            `;

            try {
                const result = await callGeminiApi(systemPrompt, context);
                intakeState.generatedSoap = result;
                renderReview(result);
                showSection('review');
            } catch (err) {
                console.error(err);
                showError('questions', 'Failed to generate SOAP note. Please try again.');
                showSection('questions');
            }
        });

        document.getElementById('questions-back-btn').addEventListener('click', () => showSection('intake'));


        // --- Step 3: Review & Select ---
        function renderReview(soap) {
            // Emergency Alert
            const alert = document.getElementById('emergency-alert');
            if(soap.plan.is_emergency) {
                document.getElementById('emergency-reason').textContent = soap.plan.emergency_reason;
                alert.classList.remove('hidden');
            } else {
                alert.classList.add('hidden');
            }

            // Assessment
            document.getElementById('review-diagnosis').textContent = soap.assessment.synthesis_statement;
            const ddxList = document.getElementById('review-ddx-list');
            ddxList.innerHTML = soap.assessment.ddx.map(d => `
                <li class="flex items-start p-1 border-b border-gray-800">
                    <span class="text-orange-500 mr-2 font-bold">â€¢</span>
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <strong class="text-white">${d.name} <span class="text-gray-500 text-xs font-normal ml-1">[${d.icd10}]</span></strong>
                            <span class="text-xs font-mono text-orange-300 bg-gray-800 px-2 rounded">${d.likelihood}</span>
                        </div>
                        <p class="text-gray-400 text-xs">${d.desc}</p>
                    </div>
                </li>
            `).join('');

            // Helper for checkboxes
            const createCheckboxes = (containerId, items, category) => {
                const cont = document.getElementById(containerId);
                cont.innerHTML = '';
                items.forEach((item, idx) => {
                    cont.innerHTML += `
                        <label class="flex items-start space-x-2 p-2 rounded hover:bg-gray-800 cursor-pointer border border-transparent hover:border-gray-700 transition-colors">
                            <input type="checkbox" checked class="mt-1 text-orange-600 rounded focus:ring-orange-500 item-check" data-cat="${category}" data-val="${item}">
                            <span class="text-sm text-gray-300 leading-tight">${item}</span>
                        </label>
                    `;
                });
            };

            createCheckboxes('review-workup-container', soap.plan.workup, 'workup');
            createCheckboxes('review-treatment-container', soap.plan.treatment, 'treatment');
            createCheckboxes('review-profile-container', soap.plan.profile.commander_limitations, 'profile');
            
            document.getElementById('profile-days').value = soap.plan.profile.days;
        }

        document.getElementById('review-continue-btn').addEventListener('click', () => {
            renderFinalNote();
            showSection('final');
        });

        document.getElementById('review-back-btn').addEventListener('click', () => showSection('questions'));


        // --- Step 4: Final Note Logic ---
        function renderFinalNote() {
            const soap = intakeState.generatedSoap;
            
            // Gather checked items
            const getChecked = (cat) => {
                return Array.from(document.querySelectorAll(`.item-check[data-cat="${cat}"]:checked`)).map(cb => cb.dataset.val);
            };

            const selectedWorkup = getChecked('workup');
            const selectedTx = getChecked('treatment');
            const selectedProf = getChecked('profile');
            const profDays = document.getElementById('profile-days').value;

            // Build String
            let note = `SUBJECTIVE:\n`;
            note += `${soap.subjective.hpi_paragraph}\n\n`;
            note += `Review of Systems:\n`;
            soap.subjective.ros_bullets.forEach(b => note += `- ${b}\n`);

            note += `\nOBJECTIVE:\n`;
            note += `Vitals: ${intakeState.vitals || "Not recorded"}\n`;
            note += `Physical Exam: ${intakeState.physicalExam || "Not recorded"}\n`;
            note += `PMH: ${intakeState.pmh || "None"}\n`;
            note += `Allergies: ${intakeState.allergies || "NKDA"}\n`;
            note += `Current Meds: ${intakeState.meds || "None"}\n`;
            note += `Prior Labs/Img: ${intakeState.priorLabs || "None"}\n`;

            note += `\nASSESSMENT:\n`;
            note += `${soap.assessment.synthesis_statement}\n\n`;
            note += `Differential Diagnosis:\n`;
            soap.assessment.ddx.forEach(d => note += `- ${d.name} [${d.icd10}] (${d.likelihood}): ${d.desc}\n`);

            note += `\nPLAN:\n`;
            note += `Disposition: ${soap.plan.disposition}\n\n`;
            
            note += `Workup (Labs/Rads/Consults):\n`;
            if(selectedWorkup.length) selectedWorkup.forEach(w => note += `- ${w}\n`);
            else note += `- None\n`;

            note += `\nTreatment / Education:\n`;
            if(selectedTx.length) selectedTx.forEach(t => note += `- ${t}\n`);
            else note += `- None\n`;

            note += `\nProfile (Duration: ${profDays} days):\n`;
            note += `Commander Limitations:\n`;
            if(selectedProf.length) selectedProf.forEach(l => note += `- ${l}\n`);
            else note += `- No specific limitations.\n`;
            
            note += `Soldier Instructions:\n`;
            soap.plan.profile.soldier_instructions.forEach(i => note += `- ${i}\n`);

            document.getElementById('final-note-content').textContent = note;

            // References (Separate Section)
            const refList = document.getElementById('references-list');
            refList.innerHTML = '';
            if (soap.references && soap.references.length > 0) {
                soap.references.forEach(ref => {
                    refList.innerHTML += `
                        <li>
                            <a href="${ref.url}" target="_blank" class="text-blue-400 hover:underline flex items-center">
                                ${ref.title}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-1 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                            </a>
                        </li>
                    `;
                });
                document.getElementById('references-container').classList.remove('hidden');
            } else {
                document.getElementById('references-container').classList.add('hidden');
            }
        }

        // --- Refinement Logic ---
        document.getElementById('refine-btn').addEventListener('click', async () => {
            const query = document.getElementById('refine-input').value;
            const responseBox = document.getElementById('refine-response');
            
            if(!query) return;
            
            responseBox.textContent = "Asking AI...";
            responseBox.classList.remove('hidden');

            const sysPrompt = "You are a helpful medical assistant. The medic has a generated plan but has a follow-up question. Answer concisely in plain text.";
            const context = `Current Context: Patient with ${intakeState.chiefComplaint}. The user asks: ${query}`;

            try {
                const answer = await callGeminiText(sysPrompt, context);
                responseBox.textContent = `AI: ${answer}`;
            } catch(e) {
                responseBox.textContent = "Error getting response.";
            }
        });

        // --- Utils ---
        document.getElementById('copy-note-btn').addEventListener('click', () => {
            const text = document.getElementById('final-note-content').textContent;
            
            // Fallback for iframe restrictions
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; // Avoid scrolling to bottom
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    document.getElementById('copy-success').classList.remove('hidden');
                    setTimeout(() => document.getElementById('copy-success').classList.add('hidden'), 2000);
                } else {
                     console.error('Fallback: Copying text command was unsuccessful');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            
            document.body.removeChild(textArea);
        });

        document.getElementById('start-over-btn').addEventListener('click', () => location.reload());
        
        // Initial Load
        showSection('intake');

    </script>
</body>
</html>
